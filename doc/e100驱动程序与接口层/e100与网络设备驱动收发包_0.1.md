## 缘起

+ 最近业余时间在投**协议栈**，把前面的几章都放在一起，用inetl e100网卡驱动为例来串一下数据的收发

## 内容

### outline

+ pci插槽的网卡
+ pci百兆网卡的驱动结构体与实例
+ e100网卡的注册和注销，e100_probe/e100_remove
+ e100网卡的启用与禁用（用户层命令）
+ 数据包的收发（接口层的输入/输出）
  + 可能*《TCP/IP架构设计与应用》chap18*讲得更好一点，还没开始看
+ 其它
  + **载波**的理解

### 2.1、pci插槽的网卡

+ 网上搜一下“PCI 百兆网卡”即可，有个大概的概念
+ 有以下几个部分组成
  + PCI接口，*为了与计算机通信*
  + 网卡控制器，**网卡芯片组**里，用于数据的收发
  + PHY芯片，**数字信号转换为模拟信号**，以太网的物理信号
  + RJ45接口，*连网线*
  + 存储器，*存储固件信息，收包器*
  + 指示灯，*网络工作状态*

### 2.2、pci百兆网卡的驱动结构体与实例

+ pci设备（硬件设备，mac唯一），pci_device_id结构体（**mod_device.h**）决定，这个文件里**记录都是系统中的设备**，
+ pci.h
  + `pci_dev`，定义了一个**pci设备**
  + pci设备里面有个**驱动**，就是`struct pci_driver`
  + pci_driver结构体里，**需要讲一下基本的驱动结构**，那就是`struct drvier_device`
+ 以e100.c文件为例，需要**创建pci_driver的实例e100_driver**， `e100_init_module`进行初始化，再调用pci_register_driver【pci与驱动关联】，实现是在`pci_driver.c`中，暂没太关注，
+ 一切就绪后，*自动触发*【网上查的】`e100_probe`

### 2.3、e100网卡的注册和注销，e100_probe/e100_remove

+ **这2个函数，都属于`e100_driver`实例中的**

#### e100_probe

+ 定义`struct net_device *netdev`的实例是由`alloc_etherdev()`创建，**分配空间**
+ 创建OK了要去**注册**，`register_netdev()` 【dev.c中实现】，*也能理解，属于网络设备了*

#### e100_remove

*未看*

### 2.4、e100网卡的启用与禁用（用户层命令）

#### 用户态命令（ifconfig，ethtool）

+ *最终整定都是调用ioctl*，当然ioctl在内核侧也分2种情况

### 2.5、数据包的收发（接口层的输入/输出）

+ *这个还没系统串起来*

### 2.6、其它

+ **载波**

## 最后

+ 希望整到1.0的时候，可以出一个能看的版本，也把书中的前8章，真的给搞懂了

### 履历

+ 0.1版，大概是懂了（2.1-2.3），2.4启停嘛，毕竟也操作过，有点概念，但内核具体的没看过，2.5收发完全是浆糊，2024-08-09整了一版，时长1个cubi